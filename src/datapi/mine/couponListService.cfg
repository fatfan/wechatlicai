var ghost = require('../cfg/ghost.js')
var gapi = require('../cmn/gapi.js')

exports.itfconf = function() {
    return new CurrentAPI().conf()
}

exports.itfleft = function(req, res, fld, fle) {
    return new CurrentAPI().output(req, res, fld, fle)
}

var CurrentAPI = gapi.BaseAPI.extend({
    conf: function() {
        return {
            auth: false,
            type: 'json',
            itfs: [{
                host: ghost.dscm.dcbusiness.addr,
                port: ghost.dscm.dcbusiness.port,
                iurl: '/wechatQuanApp?actn=activeCoupon',
                uuid: 'wechatQuanApp',
                meth: 'post',
                type: 'sdcm',
                next: [],
                func: function(req, res, fld, fle) {
                    return new CurrentAPI('wechatQuanApp').callFunc(req, res, fld, fle)
                }
            }]
        }
    },

    doCallFunc: function(uuid, req, res, fld, fle) {
        var userID = req.session.user.userId
        // var userID = 922713
        var ipAddr = gapi.getIPv4(req.user.addr)
        var page = 1
        var size = 10
        if (gapi.emptyEqual(userID, '')) {
            res.jsonp(gapi.toResult(1, '请先登录'))
            ghost.getLogger().error("[doCallFunc]IP：%s, service: mine.coupon.couponListService, dc: wechatQuanApp.activeCoupon, message: 'param error', param: userId=%s", ipAddr, userID)
            return null
        }
        ghost.getLogger().info("[doCallFunc]IP：%s, service: mine.coupon.couponListService, dc: wechatQuanApp.activeCoupon, message: 'params', params: userID=%s", ipAddr, userID)
        return {
            'claz': "['java.lang.Long', 'int', 'int']",
            'json': [userID, page, size]
        }
    },

    doOutput: function(req, res, fld, fle) {
        var ip = gapi.getIPv4(req.user.addr)
        if (!req.rslt['wechatQuanApp']) {
            ghost.getLogger().error("[doOutput]IP：%s, service: mine.coupon.couponListService, dc: wechatQuanApp.activeCoupon, message: 'rslt is null', rslt: %s", ip, JSON.stringify(req.rslt['wechatQuanApp']))
            return gapi.toResult(500, '系统异常')
        }
        if (gapi.emptyNoequal(req.rslt['wechatQuanApp'].code, 0)) {
            // 这里根据后端服务返回的code值不同提示信息不同
            if (gapi.emptyEqual(req.rslt['wechatQuanApp'].message, '')) {
                req.rslt['wechatQuanApp'].message = '数据加载失败'
            }
            ghost.getLogger().error("[doOutput]IP：%s, service: mine.coupon.couponListService, dc: wechatQuanApp.activeCoupon, message: 'rslt error', rslt: %s", ip, JSON.stringify(req.rslt['wechatQuanApp']))
            return gapi.toResult(1, req.rslt['wechatQuanApp'].message)
        }
        ghost.getLogger().info("[doOutput]IP：%s, service: mine.coupon.couponListService, dc: wechatQuanApp.activeCoupon, message: 'success', rslt: %s", ip, JSON.stringify(req.rslt['wechatQuanApp']))
        return gapi.toResult(0, 'success', req.rslt['wechatQuanApp'])
    }
})

var ghost = require('../cfg/ghost.js')
var gapi = require('../cmn/gapi.js')

exports.itfconf = function() {
    return new CurrentAPI().conf()
}
exports.itfleft = function(req, res, fld, fle) {
    return new CurrentAPI().output(req, res, fld, fle)
}
var CurrentAPI = gapi.BaseAPI.extend({
    conf: function() {
        return {
            auth: false,
            type: 'json',
            itfs: [
                {
                    host: ghost.dscm.dcbusiness.addr,
                    port: ghost.dscm.dcbusiness.port,
                    iurl: '/wechatInverstListApp?actn=inviteList',
                    uuid: 'wechatInverstListApp',
                    meth: 'post',
                    type: 'sdcm',
                    next: [],
                    func: function(req, res, fld, fle) {
                        return new CurrentAPI('wechatInverstListApp')
                            .callFunc(req, res, fld, fle)
                    }
                }
            ]
        }
    },

    doCallFunc: function(uuid, req, res, fld, fle) {
        var page = gapi.getParameter(req, 'page')
        var rows = gapi.getParameter(req, 'rows')
        var userId = req.session.user.userId
        // var userId = 922713
        var ip = gapi.getIPv4(req.user.addr)
        if (gapi.emptyEqual(page, '')) {
            res.jsonp({'code': 1, 'message': '页数不能为空'})
            ghost.getLogger().info("[doCallFunc]IP：%s, service: more.inviteHtmService, dc: wechatInverstListApp, message: 'param error', param: userId=%s,page=%s", ip, userId, page)
            return null
        }
        if (gapi.emptyEqual(rows, '')) {
            res.jsonp({'code': 1, 'message': '每页几条不能为空'})
            ghost.getLogger().info("[doCallFunc]IP：%s, service: more.inviteHtmService, dc: wechatInverstListApp, message: 'param error', param: userId=%s,rows=%s", ip, userId, rows)
            return null
        }
        ghost.getLogger().info("[doCallFunc]IP：%s, service: more.inviteHtmService, dc: wechatInverstListApp, message: 'param', param: userId=%s, page=%s, rows=%s", ip, userId, page, rows)
        return {
            'claz': "['long','int','int']",
            'json': [userId, page, rows]
        }
    },

    doOutput: function(req, res, fld, fle) {
        var ip = gapi.getIPv4(req.user.addr)
        if (!req.rslt['wechatInverstListApp']) {
            ghost.getLogger().error("[doOutput]IP：%s, service: more.inviteHtmService, dc: wechatInverstListApp, message: 'rslt is null', rslt: %s", ip, JSON.stringify(req.rslt['wechatInverstListApp']))
            return gapi.toResult(500, '系统异常')
        }
        var codes = [0, 4020, 4021]
        if (codes.indexOf(req.rslt['wechatInverstListApp'].code) === -1) {
            // 这里根据后端服务返回的code值不同提示信息不同
            if (gapi.emptyEqual(req.rslt['wechatInverstListApp'].message, '')) {
                req.rslt['wechatInverstListApp'].message = '获取信息失败'
            }
            ghost.getLogger().error("[doOutput]IP：%s, service: more.inviteHtmService, dc: wechatInverstListApp, message: 'rslt error', rslt: %s", ip, JSON.stringify(req.rslt['wechatInverstListApp']))
            return gapi.toResult(1, req.rslt['wechatInverstListApp'].message)
        }
        return gapi.toResult(null, null, req.rslt['wechatInverstListApp'])
    }
})

'use strict'

const path = require('path')
// const name = path.relative(process.argv[2], __dirname) + path.sep + path.basename(__filename, path.extname(__filename))

var ghost = require('../cfg/ghost.js')
var gapi = require('../cmn/gapi.js')

// 首页数据

exports.itfconf = function() {
    return new CurrentAPI().conf()
}

exports.itfleft = function(req, res, fld, fle) {
    return new CurrentAPI().output(req, res, fld, fle)
}

var CurrentAPI = gapi.BaseAPI.extend({
    conf: function() {
        return { auth: false,
            type: 'json',
            itfs: [
                {
                    host: ghost.dscm.dcbusiness.addr,
                    port: ghost.dscm.dcbusiness.port,
                    iurl: '/wechatInverstListApp?actn=frontInverst',
                    uuid: 'wechatInverstListApp',
                    meth: 'post',
                    type: 'sdcm',
                    next: [],
                    func: function(req, res, fld, fle) {
                        return new CurrentAPI('wechatInverstListApp')
                            .callFunc(req, res, fld, fle)
                    }
                }
            ]
        }
    },

    doCallFunc: function(uuid, req, res, fld, fle) {
        var ip = gapi.getIPv4(req.user.addr)
        var size = 3
        ghost.getLogger().info("[doCallFunc]IP：%s, service: datasvr.invest.list, dc: wechatInverstListApp, message: 'param', param: size=%s", ip, size)
        return {
            'claz': "['java.lang.Integer']",
            'json': [size]
        }
    },

    doOutput: function(req, res, fld, fle) {
        // const ip = gapi.getIPv4(req.user.addr)

        const result = req.rslt['wechatInverstListApp']
        if (!result) {
            // ghost.getLogger().error(`${req.id || ip} dscm-output-empty: (${name})`);
            res.jsonp({ code: 500, message: '系统异常' })
            return
        }

        if (result.code !== 0) {
            result.message = result.message || '数据加载失败'
            // ghost.getLogger().error(`${req.id || ip} dscm-output-error: (${name}) ${JSON.stringify(result)}`);
            return result
        }

        if (req.rslt['wechatInverstListApp'] && req.rslt['wechatInverstListApp'].realTimeFinancial) {
            var d0 = new Date('2012/08/28')
            req.rslt['wechatInverstListApp'].realTimeFinancial.operationDays = Math.ceil((Date.now() - d0.getTime()) / 24 / 60 / 60 / 1000)
        }

        // ghost.getLogger().info(`${req.id || ip} dscm-output: (${name}) ${JSON.stringify(result)}`);
        return result
    }
})

var ghost = require(process.argv[2] + '/webchat/cfg/ghost.js')
var gapi = require(process.argv[2] + '/webchat/cmn/gapi.js')

exports.itfconf = function() {
    return new CurrentAPI().conf()
}

exports.itfleft = function(req, res, fld, fle) {
    return new CurrentAPI().output(req, res, fld, fle)
}

var CurrentAPI = gapi.BaseAPI.extend({
    conf: function() {
        return {
            auth: false,
            type: 'json',
            itfs: [
                {
                    host: ghost.dscm.dcbusiness.addr,
                    port: ghost.dscm.dcbusiness.port,
                    iurl: '/wechatInvestListApp?actn=detailImpl',
                    uuid: 'wechatInvestListApp',
                    meth: 'post',
                    type: 'sdcm',
                    next: [],
                    func: function(req, res, fld, fle) {
                        return new CurrentAPI('wechatInvestListApp')
                            .callFunc(req, res, fld, fle)
                    }
                }
            ]
        }
    },

    doCallFunc: function(uuid, req, res, fld, fle) {
        var id = gapi.getParameter(req, 'id')
        var ip = gapi.getIPv4(req.user.addr)

        ghost.getLogger().info("[doCallFunc]IP：%s, service: datasvr.invest.loanDetail, dc: wechatInvestListApp, message: 'param', param: id=%s", ip, id)
        return {
            'claz': "['java.lang.Long']",
            'json': [id]
        }
    },

    doOutput: function(req, res, fld, fle) {
        var ip = gapi.getIPv4(req.user.addr)
        if (!req.rslt['wechatInvestListApp']) {
            ghost.getLogger().error("[doOutput]IP：%s, service: datasvr.invest.loanDetail, dc: wechatInvestListApp, message: 'rslt is null', rslt: %s", ip, JSON.stringify(req.rslt['wechatInvestListApp']))
            return gapi.toResult(500, '系统异常')
        }

        if (gapi.emptyNoequal(req.rslt['wechatInvestListApp'].code, 0)) {
            // 这里根据后端服务返回的code值不同提示信息不同
            if (gapi.emptyEqual(req.rslt['wechatInvestListApp'].message, '')) {
                req.rslt['appResetPayPwd'].message = '获取信息失败'
            }
            ghost.getLogger().error("[doOutput]IP：%s, service: datasvr.invest.loanDetail, dc: wechatInvestListApp, message: 'rslt error', rslt: %s", ip, JSON.stringify(req.rslt['wechatInvestListApp']))
            return gapi.toResult(202, req.rslt['wechatInvestListApp'].message)
        }
        // 信息加密的函数
        function fmtRe(nameStr, num) {
            if (nameStr !== undefined) {
                if (nameStr.length > num) {
                    nameStr = '**' + nameStr.substring(nameStr.length - num, nameStr.length)
                } else {
                    nameStr = '**' + nameStr.substr(-1, 1)
                }
            } else {
                nameStr = '**'
            }
            return nameStr
        }
        if (req.rslt['wechatInvestListApp'].data.selfInfo) {
            // changed by lws 20160705 手机号保留后四位，用户名保留后两位
            var nameVal = req.rslt['wechatInvestListApp'].data.selfInfo.userName
            var phoneVal = req.rslt['wechatInvestListApp'].data.selfInfo.userPhone
            req.rslt['wechatInvestListApp'].data.selfInfo.userName = fmtRe(nameVal, 2)
            req.rslt['wechatInvestListApp'].data.selfInfo.userPhone = fmtRe(phoneVal, 4)
        }
        if (req.rslt['wechatInvestListApp'].data.company) {
            // req.rslt['wechatInvestListApp'].data.company.companyName = req.rslt['wechatInvestListApp'].data.company.companyName.substring(0,1)+"**";
            req.rslt['wechatInvestListApp'].data.company.companyName = '**有限公司'// changed by lws  公司名直接写死
        }

        return gapi.toResult(200, '', req.rslt['wechatInvestListApp'])
    }
})
